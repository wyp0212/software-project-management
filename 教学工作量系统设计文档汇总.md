# 教学工作量系统设计文档汇总

## 一、需求规格说明书

### 1.1 系统概述

教学工作量系统是一个基于Web的教学工作量管理平台，用于管理教师的教学任务和工作量统计。系统采用ASP.NET技术开发，使用SQL Server数据库。

### 1.2 功能需求

#### 1.2.1 系统管理模块
- **院系设置**：管理院系基本信息（院系编号、院系名称、有效标志）
- **职称设置**：管理职称信息（职称编号、职称名称、职称类型、标准工作量）
- **管理员设置**：管理系统管理员和教学秘书账号
- **学年度设置**：设置和管理学年度信息，支持默认学年设置
- **系统日志**：记录系统操作日志，包括登录失败、系统异常等

#### 1.2.2 基本信息模块
- **教师信息管理**：教师编号、姓名、性别、职称、职务、所属院系、在职状态
- **专业信息管理**：专业编号、专业名称、所属院系
- **班级信息管理**：班级编号、班级名称、班级人数、有效标志
- **课程信息管理**：课程编号、课程名称、课程性质、课程类型、是否开设课程设计、有效标志

#### 1.2.3 教学任务模块
- **课程任务**：管理教师承担的课程教学任务
  - 教师编号、课程编号、教学班编号
  - 开办学年、开办学期
  - 理论学时、理论当量系数
  - 实验学时、实验当量系数
- **课程设计任务**：管理课程设计教学任务
- **实习任务**：管理实习教学任务
- **毕业设计任务**：管理毕业设计指导任务
- **教学班管理**：教学班编号、教学班名称、教学班总人数、关联班级

#### 1.2.4 工作量查询统计模块
- **工作量查询**：按教师、学年、学期等条件查询工作量
- **工作量统计**：统计教师总工作量、工作量完成情况
- **导出报表**：导出工作量统计报表

### 1.3 用户角色

1. **管理员（admin）**
   - 拥有系统所有权限
   - 可以管理系统设置、基本信息、教学任务、工作量查询统计

2. **教学秘书（secretary）**
   - 可以管理基本信息、教学任务、工作量查询统计
   - 不能管理系统设置

3. **教师（teacher）**
   - 只能查看自己的信息和工作量
   - 可以修改个人密码

### 1.4 非功能需求

- **安全性**：密码加密存储，使用Encrypt类进行加密/解密
- **日志记录**：使用EventsLog类记录系统操作日志
- **数据安全**：使用GetSafeData类防止NULL值异常
- **SQL注入防护**：使用SQLString类进行SQL字符串安全处理

---

## 二、数据库设计

### 2.1 数据库概述

- **数据库名称**：Gzl
- **数据库类型**：SQL Server
- **连接字符串**：server=YANG;database=Gzl;User Id=sa;pwd=sa

### 2.2 数据表设计

#### 2.2.1 系统管理相关表

**1. 操作员表（czyb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| czy | varchar | 操作员（主键） |
| dlmm | varchar | 登录密码（加密） |
| yxbh | varchar | 院系编号（外键→yxb.yxbh） |
| qx | varchar | 权限（管理员/教学秘书） |

**2. 院系表（yxb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| yxbh | varchar | 院系编号（主键） |
| yxmc | varchar | 院系名称 |
| yxbz | bit | 有效标志 |

**3. 职称表（zcb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| zcbh | varchar | 职称编号（主键） |
| zcmc | varchar | 职称名称 |
| zclx | varchar | 职称类型 |
| bzgzl | int | 标准工作量 |

**4. 职务表（zwb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| zwbh | varchar | 职务编号（主键） |
| zwlx | varchar | 职务类型 |

**5. 学年度表（xndb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| xnd | varchar | 学年度（主键） |
| mrxn | bit | 默认学年标志 |

#### 2.2.2 基本信息相关表

**6. 教师表（jsb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| jsbh | varchar | 教师编号（主键） |
| jsxm | varchar | 教师姓名 |
| jsxb | varchar | 教师性别 |
| yxbh | varchar | 院系编号（外键→yxb.yxbh） |
| zcbh | varchar | 职称编号（外键→zcb.zcbh） |
| zwbh | varchar | 职务编号（外键→zwb.zwbh） |
| dlmm | varchar | 登录密码（加密） |
| zzzt | bit | 在职状态 |

**7. 专业表（zyb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| zybh | varchar | 专业编号（主键） |
| zymc | varchar | 专业名称 |
| yxbh | varchar | 院系编号（外键→yxb.yxbh） |

**8. 班级表（bjb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| bjbh | varchar | 班级编号（主键） |
| bjmc | varchar | 班级名称 |
| bjrs | int | 班级人数 |
| yxbz | bit | 有效标志 |

**9. 课程表（kcb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| kcbh | varchar | 课程编号（主键） |
| kcmc | varchar | 课程名称 |
| kcxz | varchar | 课程性质 |
| kclx | varchar | 课程类型 |
| fdkcsj | bit | 是否开设课程设计 |
| yxbz | bit | 有效标志 |

#### 2.2.3 教学任务相关表

**10. 教学班表（jxbb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| jxbbh | varchar | 教学班编号（主键） |
| jxbmc | varchar | 教学班名称 |
| jxbzrs | varchar | 教学班总人数 |

**11. 班级教学班关系表（bj_jxb_gxb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| jxbbh | varchar | 教学班编号（外键→jxbb.jxbbh） |
| bjbh | varchar | 班级编号（外键→bjb.bjbh） |

**12. 教师课程关系表（js_kc_gxb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| jsbh | varchar | 教师编号（外键→jsb.jsbh） |
| kcbh | varchar | 课程编号（外键→kcb.kcbh） |
| jxbbh | varchar | 教学班编号（外键→jxbb.jxbbh） |
| kbxn | varchar | 开办学年 |
| kbxq | varchar | 开办学期 |
| llxs | int | 理论学时 |
| lldxs | double | 理论当量系数 |
| syxs | int | 实验学时 |
| sydxs | double | 实验当量系数 |

**13. 课程设计表（kcsjb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| kcsjbh | varchar | 课程设计编号（主键） |
| kcsjmc | varchar | 课程设计名称 |

**14. 教师课程设计关系表（js_kcsj_gxb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| jsbh | varchar | 教师编号（外键→jsb.jsbh） |
| kcsjbh | varchar | 课程设计编号（外键→kcsjb.kcsjbh） |
| jxbbh | varchar | 教学班编号（外键→jxbb.jxbbh） |
| kbxn | varchar | 开办学年 |
| kbxq | varchar | 开办学期 |
| xs | int | 周数 |

**15. 实习表（sxb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| jsbh | varchar | 教师编号（外键→jsb.jsbh） |
| bjbh | varchar | 班级编号（外键→bjb.bjbh） |
| kbxn | varchar | 开办学年 |
| kbxq | varchar | 开办学期 |
| sxmc | varchar | 实习名称 |
| xs | int | 周/天数 |

**16. 毕业设计表（bysjb）**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| jsbh | varchar | 教师编号（外键→jsb.jsbh） |
| kbxn | varchar | 开办学年 |
| kbxq | varchar | 开办学期 |
| rs | int | 人数 |
| xs | int | 周数 |

### 2.3 视图设计

根据代码分析，系统使用了以下视图：

1. **viewKcrw** - 课程任务视图
2. **viewKcsjrw** - 课程设计任务视图
3. **viewSxrw** - 实习任务视图
4. **viewBysjrw** - 毕业设计任务视图

### 2.4 存储过程

- **proJsZgzlJs** - 计算教师总工作量

---

## 三、详细设计

### 3.1 系统架构设计

#### 3.1.1 分层架构

系统采用三层架构：

1. **表示层（Presentation Layer）**
   - ASP.NET Web Forms页面（.aspx）
   - 页面代码隐藏文件（.aspx.cs）
   - CSS样式文件
   - JavaScript脚本文件

2. **业务逻辑层（Business Logic Layer）**
   - 位置：`App_Code/BusinessLogicLayer/`
   - 实体类：User, JS, KC, KCRW, BJ, JXB, YX, ZC, XND等
   - 每个实体类包含：
     - 私有成员变量
     - 公共属性
     - LoadData()方法：加载数据
     - Add()方法：添加数据
     - Update()方法：更新数据
     - Delete()方法：删除数据
     - Query()方法：查询数据
     - HasXXX()方法：判断是否存在

3. **数据访问层（Data Access Layer）**
   - 位置：`App_Code/DataAccessLayeer/`
   - Database类：封装数据库操作
   - GetSafeData类：安全数据提取
   - SQLString类：SQL字符串构造

#### 3.1.2 公共组件层（Common Component Layer）

- **Encrypt类**：加密/解密工具
  - EncryptString()：加密字符串
  - DecryptString()：解密字符串
  - 使用XOR算法，密钥为用户登录名

- **EventsLog类**：事件日志记录
  - WriteLog()：写入日志
  - ReadLog()：读取日志
  - 记录到Windows事件日志

### 3.2 核心类设计

#### 3.2.1 Database类

```csharp
public class Database : IDisposable
{
    // 主要方法
    public SqlDataReader GetDataReader(String SqlString)
    public DataSet GetDataSet(String SqlString)
    public DataTable GetDataTable(String SqlString)
    public DataRow GetDataRow(String SqlString)
    public int ExecuteSQL(String SqlString)
    public bool ExecuteSQL(String[] SqlStrings)  // 事务执行
    public bool Insert(String TableName, Hashtable Cols)
    public bool Update(String TableName, Hashtable Cols, String Where)
    public void Close()
    public void Dispose()
}
```

**特点**：
- 自动管理数据库连接
- 支持事务处理
- 异常处理和日志记录
- 实现IDisposable接口

#### 3.2.2 GetSafeData类

提供安全的数据提取方法，防止NULL值异常：

```csharp
public class GetSafeData
{
    // DataRow方法
    public static string ValidateDataRow_S(DataRow row, string colname)  // 字符串
    public static int ValidateDataRow_N(DataRow row, string colname)     // 整数
    public static double ValidateDataRow_F(DataRow row, string colname)  // 浮点数
    public static DateTime ValidateDataRow_T(DataRow row, string colname) // 日期时间
    public static Boolean ValidateDataRow_B(DataRow row, string colname)  // 布尔值
    
    // SqlDataReader方法（类似）
    public static string ValidateDataReader_S(SqlDataReader reader, string colname)
    // ... 其他类型
}
```

#### 3.2.3 SQLString类

```csharp
public class SqlStringConstructor
{
    // 转义SQL字符串，防止SQL注入
    public static String GetQuotedString(String pStr)
    
    // 构造WHERE子句
    public static String GetConditionClause(Hashtable queryItems)
    public static String GetConditionClause(Hashtable queryItems, string type)  // AND/OR
}
```

### 3.3 页面设计

#### 3.3.1 登录页面（Login.aspx）

**功能**：
- 管理员登录
- 教师登录
- 表单验证（用户名4位，密码3-16位）
- 密码验证和权限判断
- 登录失败日志记录

**流程**：
1. 用户输入用户名和密码
2. 选择登录类型（管理员/教师）
3. 验证用户存在性
4. 验证密码（解密后比较）
5. 设置Session（login_name, mark, xnd）
6. 跳转到对应首页

#### 3.3.2 管理员首页（index.aspx）

**功能模块**：
- 系统管理菜单
- 基本信息菜单
- 教学任务菜单
- 工作量菜单
- 用户信息显示
- 学年度显示

**权限控制**：
- 使用`judgeJxms.aspx`判断权限
- 允许管理员和教学秘书访问

#### 3.3.3 教师首页（teacher.aspx）

**功能**：
- 显示教师基本信息
- 显示总工作量和工作量情况
- 显示课程工作量明细（GridView）
- 显示课程设计工作量明细
- 显示实习工作量明细
- 显示毕业设计工作量明细

**权限控制**：
- 使用`judgeJs.aspx`判断权限
- 只允许教师访问

### 3.4 权限控制设计

#### 3.4.1 权限判断页面

**judgeGly.aspx.cs** - 管理员权限判断
```csharp
if (Session["mark"] == null || Session["login_name"] == null)
    Response.Redirect("error01.aspx");
else if (Session["mark"].ToString() != "admin")
    Response.Redirect("error01.aspx");
```

**judgeJs.aspx.cs** - 教师权限判断
```csharp
if (Session["mark"] == null || Session["login_name"] == null)
    Response.Redirect("error02.aspx");
else if (Session["mark"].ToString() != "teacher")
    Response.Redirect("error02.aspx");
```

**judgeJxms.aspx.cs** - 管理员/教学秘书权限判断
```csharp
if (Session["mark"] == null || Session["login_name"] == null)
    Response.Redirect("error01.aspx");
else if (Session["mark"].ToString() != "admin" && Session["mark"].ToString() != "secretary")
    Response.Redirect("error01.aspx");
```

### 3.5 数据流程设计

#### 3.5.1 登录流程

```
用户输入 → Login.aspx → Login.aspx.cs
    ↓
验证用户名和密码
    ↓
User.LoadData() / JS.LoadData()
    ↓
Database.GetDataRow()
    ↓
解密密码比较
    ↓
设置Session
    ↓
跳转首页
```

#### 3.5.2 数据查询流程

```
页面请求 → Page_Load()
    ↓
业务逻辑层.Query()
    ↓
Database.GetDataTable()
    ↓
GetSafeData验证数据
    ↓
绑定到GridView
    ↓
页面显示
```

#### 3.5.3 数据修改流程

```
用户输入 → 表单验证
    ↓
业务逻辑层.Add()/Update()
    ↓
构造Hashtable
    ↓
Database.Insert()/Update()
    ↓
执行SQL
    ↓
返回结果
```

### 3.6 安全设计

#### 3.6.1 密码加密

- 使用Encrypt类进行加密
- 密钥为用户登录名
- 存储到数据库前加密
- 验证时解密比较

#### 3.6.2 SQL注入防护

- 使用SQLString.GetQuotedString()转义单引号
- 使用参数化查询（部分）
- 避免直接拼接SQL字符串

#### 3.6.3 会话管理

- 使用Session存储用户信息
- Session超时时间：30分钟
- 每个页面检查Session有效性

#### 3.6.4 异常处理

- Database类中捕获异常
- 记录到事件日志
- 返回错误信息给用户

### 3.7 性能优化

1. **数据库连接管理**
   - 使用连接池
   - 及时关闭连接
   - 实现IDisposable接口

2. **数据访问优化**
   - 使用DataReader读取大量数据
   - 使用DataSet缓存数据
   - 使用视图简化查询

3. **页面优化**
   - CSS文件分离
   - JavaScript文件分离
   - 图片资源优化

---

## 四、模块详细设计

### 4.1 基本信息和系统设置模块

#### 4.1.1 院系设置（pageYxsz.aspx）

**功能**：
- 添加院系
- 修改院系
- 删除院系
- 查询院系

**业务逻辑**：
- YX类：LoadData(), Add(), Update(), Delete(), QueryYX()

#### 4.1.2 职称设置（pageZcsz.aspx）

**功能**：
- 添加职称
- 修改职称（包括标准工作量）
- 删除职称
- 查询职称

**业务逻辑**：
- ZC类：LoadData(), Add(), Update(), Delete(), QueryZC()

#### 4.1.3 管理员设置（pageGlysz.aspx）

**功能**：
- 添加管理员/教学秘书
- 修改管理员信息
- 删除管理员
- 查询管理员

**业务逻辑**：
- User类：LoadData(), Add(), Update(), Delete(), QueryUsers()
- 密码加密存储

#### 4.1.4 学年度设置（pageXndsz.aspx）

**功能**：
- 添加学年度
- 设置默认学年度
- 修改学年度

**业务逻辑**：
- XND类：LoadData(), Add(), Update(), HasXND()

### 4.2 教学任务模块

#### 4.2.1 课程任务（pageKcrw.aspx）

**功能**：
- 添加课程任务
- 修改课程任务
- 删除课程任务
- 查询课程任务

**业务逻辑**：
- KCRW类：LoadData(), Add(), Update(), Delete(), Query(), HasKCRW()
- 关联表：js_kc_gxb

#### 4.2.2 课程设计任务（pageKcsjrw.aspx）

**功能**：
- 管理课程设计任务
- 关联教师、课程设计、教学班

**业务逻辑**：
- KCSJRW类：管理js_kcsj_gxb表

#### 4.2.3 实习任务（pageSxrw.aspx）

**功能**：
- 管理实习任务
- 关联教师、班级

**业务逻辑**：
- SXRW类：管理sxb表

#### 4.2.4 毕业设计任务（pageBysjrw.aspx）

**功能**：
- 管理毕业设计任务
- 记录指导人数和周数

**业务逻辑**：
- BYSJ类：管理bysjb表

### 4.3 工作量查询统计模块

#### 4.3.1 工作量查询（pageGzlcx.aspx）

**功能**：
- 按教师查询工作量
- 按学年查询工作量
- 按学期查询工作量
- 多条件组合查询

**数据来源**：
- 视图：viewKcrw, viewKcsjrw, viewSxrw, viewBysjrw
- 存储过程：proJsZgzlJs

#### 4.3.2 导出报表（pageGzlbb.aspx）

**功能**：
- 导出工作量统计报表
- 支持Excel格式导出

---

## 五、技术规范

### 5.1 开发环境

- **开发工具**：Visual Studio
- **开发语言**：C# (.NET Framework 2.0)
- **Web框架**：ASP.NET Web Forms
- **数据库**：SQL Server
- **前端技术**：HTML, CSS, JavaScript

### 5.2 编码规范

1. **命名规范**
   - 类名：PascalCase（如：Database, User）
   - 方法名：PascalCase（如：LoadData, GetDataTable）
   - 私有成员：_camelCase（如：_jsbh, _jsxm）
   - 属性名：PascalCase（如：Jsbh, Jsxm）

2. **代码组织**
   - 使用#region/#endregion组织代码
   - 私有成员、属性、方法分别组织
   - 添加XML注释

3. **异常处理**
   - 使用try-catch捕获异常
   - 记录异常日志
   - 返回友好的错误信息

### 5.3 数据库规范

1. **表命名**：使用中文拼音缩写+后缀b（如：jsb, kcb）
2. **字段命名**：使用中文拼音缩写（如：jsbh, jsxm）
3. **主键**：使用业务主键（如：教师编号、课程编号）
4. **外键**：使用关联表的编号字段

---

## 六、部署说明

### 6.1 系统要求

- **服务器**：Windows Server + IIS
- **数据库**：SQL Server
- **.NET Framework**：2.0或更高版本

### 6.2 部署步骤

1. 配置IIS，创建Web应用程序
2. 复制源代码到Web目录
3. 配置web.config中的数据库连接字符串
4. 附加数据库文件（Gzl_Data.MDF）
5. 设置数据库权限
6. 测试系统功能

### 6.3 配置文件

**web.config关键配置**：
```xml
<appSettings>
    <add key="DBConnectionString" value="server=YANG;database=Gzl;User Id=sa;pwd=sa"/>
</appSettings>
<sessionState mode="InProc" timeout="30"></sessionState>
```

---

## 七、总结

本系统采用经典的三层架构设计，实现了教学工作量管理的核心功能。系统具有良好的扩展性和维护性，通过分层设计实现了代码的复用和模块化。数据库设计合理，表结构清晰，关系明确。系统安全性通过密码加密、SQL注入防护、权限控制等多方面保障。

**主要特点**：
1. 分层架构清晰
2. 代码复用性好
3. 安全性较高
4. 功能完整
5. 易于维护和扩展

